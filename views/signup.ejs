<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="signupStyle.css" />
    <title>Sign Up</title>
  </head>
  <body>
    <div class="container">
      <form
        class="w-50 mx-auto py-5 shadow p-4"
        action="/signup"
        method="POST"
        id="signupForm"
      >
        <h3 class="text-white">Sign Up Now</h3>
        <hr />
        <div class="name-group">
          <div class="mb-3">
            <label for="firstName" class="Name">First Name</label>
            <input
              type="text"
              class="form-control"
              id="firstName"
              name="firstName"
              placeholder=""
              required
            />
          </div>
          <div class="mb-3">
            <label for="lastName" class="Name">Last Name</label>
            <input
              type="text"
              class="form-control"
              id="lastName"
              name="lastName"
              placeholder=""
              required
            />
          </div>
        </div>
        <div class="mb-3">
          <label for="email" class="form-label">Email address</label>
          <button type="button" class="btn btn-link" id="verifyEmail">
            Verify Email
          </button>
          <input
            type="email"
            class="form-control"
            id="email"
            name="email"
            placeholder=""
            required
          />
        </div>
        <div class="mb-3" id="otpSection" style="display: none">
          <label for="otp" class="form-label">Enter OTP</label>
          <button type="button" class="btn btn-link" id="verifyOtpLink">
            Verify OTP
          </button>
          <input
            type="text"
            class="form-control"
            id="otp"
            name="otp"
            placeholder=""
            required
          />
        </div>
        <div class="mb-3" style="display: none" id="passwordSection">
          <label for="password" class="form-label">Password</label>
          <input
            type="password"
            class="form-control"
            id="password"
            name="password"
            required
          />
          <label for="confirmpassword" class="form-label"
            >Confirm Password</label
          >
          <input
            type="password"
            class="form-control"
            id="confirmpassword"
            name="confirm"
            required
          />
        </div>
        <div class="mb-3 d-flex" id="submitSection" style="display: none">
          <button type="submit" class="btn btn-success">Signup</button>
          <p class="form-label ms-auto mt-2">
            Already have an Account?
            <a href="/login" class="text-white">login</a>
          </p>
        </div>
        <div id="otpMessage" class="alert" style="display: none"></div>
      </form>
    </div>
    <!-- Bootstrap Bundle with Popper -->
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
      crossorigin="anonymous"
    ></script>
    <script>
      document
        .getElementById("verifyEmail")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          if (!email) {
            alert("Please enter an email.");
            return;
          }
          try {
            // Check if the user exists
            const checkUserResponse = await fetch("/check-user", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });
            const checkUserData = await checkUserResponse.json();
            if (checkUserData.exists) {
              alert(checkUserData.message);
              return; // Stop further execution if the user exists
            }

            // If user doesn't exist, proceed to send OTP
            const otpResponse = await fetch("/send-otp", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ email }),
            });
            const otpData = await otpResponse.json();
            alert(otpData.message);
            if (!otpData.error) {
              document.getElementById("otpSection").style.display = "block";
            }
          } catch (error) {
            console.error("Error:", error);
            alert("An error occurred, please try again.");
          }
        });

      document
        .getElementById("verifyOtpLink")
        .addEventListener("click", async () => {
          const email = document.getElementById("email").value;
          const otp = document.getElementById("otp").value;
          if (otp.length === 6) {
            try {
              const response = await fetch("/verify-otp", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ email, otp }),
              });
              const data = await response.json();
              if (data.success) {
                alert("OTP verified successfully. Please set your password.");
                document.getElementById("passwordSection").style.display =
                  "block";
                document.getElementById("submitSection").style.display = "flex";
              } else {
                alert(data.error);
              }
            } catch (error) {
              console.error("Error verifying OTP:", error);
              alert("Error verifying OTP, please try again.");
            }
          } else {
            alert("Please enter a 6-digit OTP.");
          }
        });

      document.getElementById("signupForm").onsubmit = async (e) => {
        e.preventDefault();
        const email = document.getElementById("email").value;
        const password = document.getElementById("password").value;
        const confirmPassword =
          document.getElementById("confirmpassword").value;
        if (password !== confirmPassword) {
          alert("Passwords do not match.");
          return;
        }
        try {
          const response = await fetch("/set-password", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, confirmPassword }),
          });
          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            alert(data.message);
            window.location.href = "/login";
          }
        } catch (error) {
          console.error("Error setting password:", error);
          alert("Error setting password, please try again.");
        }
      };
    </script>
  </body>
</html>
